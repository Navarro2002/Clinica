@model List<Clinica.Models.Usuario>
@{
    ViewBag.Title = "Usuarios";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var roles = ViewBag.Roles as List<Clinica.Models.RolUsuario>;
}

<div class="container-fluid mt-4">
    <h2>Usuarios</h2>
    <div class="card mt-3">
        <div class="card-header">
            <i class="fa fa-list"></i> Lista de usuarios
        </div>
        <div class="card-body">
            <!-- Mensajes de error y éxito -->
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger text-center">@TempData["Error"]</div>
            }
            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success text-center">@TempData["Success"]</div>
            }

            <!-- Botón para abrir modal Crear -->
            <button class="btn btn-outline-success mb-3" data-bs-toggle="modal" data-bs-target="#usuarioModal">
                Nuevo Usuario
            </button>
            <table id="usuariosTable" class="table table-bordered table-hover align-middle">
                <thead>
                    <tr>
                        <th>Nro Documento</th>
                        <th>Nombres</th>
                        <th>Apellidos</th>
                        <th>Correo</th>
                        <th>Fecha Creacion</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var usuario in Model)
                    {
                        <tr>
                            <td>@usuario.NumeroDocumentoIdentidad</td>
                            <td>@usuario.Nombre</td>
                            <td>@usuario.Apellido</td>
                            <td>@usuario.Correo</td>
                            <td>@(usuario.FechaCreacion.HasValue ? usuario.FechaCreacion.Value.ToString("dd/MM/yyyy") : "")</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button"
                                            class="btn btn-info btn-sm btn-ver"
                                            data-id="@usuario.IdUsuario"
                                            data-doc="@usuario.NumeroDocumentoIdentidad"
                                            data-nombre="@usuario.Nombre"
                                            data-apellido="@usuario.Apellido"
                                            data-correo="@usuario.Correo"
                                            data-rol="@usuario.IdRolUsuario">
                                        Ver
                                    </button>
                                    <button type="button"
                                            class="btn btn-warning btn-sm btn-editar"
                                            data-id="@usuario.IdUsuario"
                                            data-doc="@usuario.NumeroDocumentoIdentidad"
                                            data-nombre="@usuario.Nombre"
                                            data-apellido="@usuario.Apellido"
                                            data-correo="@usuario.Correo"
                                            data-rol="@usuario.IdRolUsuario">
                                        Editar
                                    </button>
                                    <button type="button"
                                            class="btn btn-danger btn-sm btn-eliminar"
                                            data-id="@usuario.IdUsuario"
                                            data-nombre="@usuario.Nombre"
                                            data-apellido="@usuario.Apellido">
                                        Eliminar
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Crear Usuario -->
<div class="modal fade" id="usuarioModal" tabindex="-1" aria-labelledby="usuarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form action="/Usuario/Create" method="post" autocomplete="off">
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title" id="usuarioModalLabel">Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="NumeroDocumentoIdentidad" class="form-label">Nro Documento:</label>
                            <input type="text" class="form-control" name="NumeroDocumentoIdentidad" required />
                        </div>
                        <div class="col-md-6">
                            <label for="Nombre" class="form-label">Nombres:</label>
                            <input type="text" class="form-control" name="Nombre" required />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="Apellido" class="form-label">Apellidos:</label>
                            <input type="text" class="form-control" name="Apellido" required />
                        </div>
                        <div class="col-md-6">
                            <label for="Correo" class="form-label">Correo:</label>
                            <input type="email" class="form-control" name="Correo" required />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="IdRolUsuario" class="form-label">Rol:</label>
                            <select class="form-select" name="IdRolUsuario" required>
                                <option value="">Seleccione un rol...</option>
                                @if (roles != null)
                                {
                                    foreach (var rol in roles)
                                    {
                                        <option value="@rol.IdRolUsuario">@rol.Nombre</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="Clave" class="form-label">Contraseña:</label>
                            <input type="password" class="form-control" name="Clave" required />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Usuario -->
<div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-labelledby="editarUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <form action="/Usuario/Edit" method="post" autocomplete="off">
                @Html.AntiForgeryToken()
                <input type="hidden" name="IdUsuario" id="edit_IdUsuario" />
                <div class="modal-header">
                    <h5 class="modal-title" id="editarUsuarioLabel">Editar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nro Documento:</label>
                            <input type="text" class="form-control" name="NumeroDocumentoIdentidad" id="edit_NumeroDocumentoIdentidad" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nombres:</label>
                            <input type="text" class="form-control" name="Nombre" id="edit_Nombre" required />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Apellidos:</label>
                            <input type="text" class="form-control" name="Apellido" id="edit_Apellido" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Correo:</label>
                            <input type="email" class="form-control" name="Correo" id="edit_Correo" required />
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Rol:</label>
                            <select class="form-select" name="IdRolUsuario" id="edit_IdRolUsuario" required>
                                <option value="">Seleccione un rol...</option>
                                @if (roles != null)
                                {
                                    foreach (var rol in roles)
                                    {
                                        <option value="@rol.IdRolUsuario">@rol.Nombre</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contraseña (opcional):</label>
                            <input type="password" class="form-control" name="Clave" id="edit_Clave" placeholder="Dejar en blanco para conservar" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Detalle Usuario -->
<div class="modal fade" id="detalleUsuarioModal" tabindex="-1" aria-labelledby="detalleUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detalleUsuarioLabel">Detalle de Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Nro Documento:</label>
                        <input type="text" class="form-control" id="view_NumeroDocumentoIdentidad" readonly />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nombres:</label>
                        <input type="text" class="form-control" id="view_Nombre" readonly />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Apellidos:</label>
                        <input type="text" class="form-control" id="view_Apellido" readonly />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Correo:</label>
                        <input type="text" class="form-control" id="view_Correo" readonly />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Rol:</label>
                        <input type="text" class="form-control" id="view_Rol" readonly />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha creación:</label>
                        <input type="text" class="form-control" id="view_FechaCreacion" readonly />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="eliminarUsuarioModal" tabindex="-1" aria-labelledby="eliminarUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form action="/Usuario/Delete" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="del_IdUsuario" />
                <div class="modal-header">
                    <h5 class="modal-title" id="eliminarUsuarioLabel">Confirmar eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar al usuario <strong id="del_Nombre"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function () {
            var dt = $('#usuariosTable').DataTable({
                pageLength: 10,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, 'Todos']],
                order: [],
                language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' }
            });

            function showModal(id) {
                var el = document.getElementById(id);
                var modal = bootstrap.Modal.getOrCreateInstance(el, { backdrop: true, keyboard: true });
                modal.show();
            }

            // Delegar eventos por DataTables
            $('#usuariosTable').on('click', '.btn-editar', function () {
                var btn = $(this);
                $('#edit_IdUsuario').val(btn.data('id'));
                $('#edit_NumeroDocumentoIdentidad').val(btn.data('doc'));
                $('#edit_Nombre').val(btn.data('nombre'));
                $('#edit_Apellido').val(btn.data('apellido'));
                $('#edit_Correo').val(btn.data('correo'));
                $('#edit_IdRolUsuario').val(btn.data('rol'));
                $('#edit_Clave').val('');
                showModal('editarUsuarioModal');
            });

            $('#usuariosTable').on('click', '.btn-ver', function () {
                var btn = $(this);
                $('#view_NumeroDocumentoIdentidad').val(btn.data('doc'));
                $('#view_Nombre').val(btn.data('nombre'));
                $('#view_Apellido').val(btn.data('apellido'));
                $('#view_Correo').val(btn.data('correo'));
                var rolId = btn.data('rol');
                var rolTexto = $('#edit_IdRolUsuario option[value="' + rolId + '"]').text();
                $('#view_Rol').val(rolTexto || '');
                var fecha = btn.closest('tr').find('td').eq(4).text();
                $('#view_FechaCreacion').val(fecha);
                showModal('detalleUsuarioModal');
            });

            $('#usuariosTable').on('click', '.btn-eliminar', function () {
                var btn = $(this);
                $('#del_IdUsuario').val(btn.data('id'));
                $('#del_Nombre').text(btn.data('nombre') + ' ' + (btn.data('apellido') || ''));
                showModal('eliminarUsuarioModal');
            });
        });
    </script>
}
